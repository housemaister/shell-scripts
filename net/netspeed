#!/bin/bash

raw=0
kb=0

while getopts ":rki:" opt; do
  case $opt in
    r)
      raw=1
      ;;
    k)
      kb=1
      ;;
    i)
      IF=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

if [ -z "$IF" ]; then
        echo $0: prints the tx/rx speed at given network interface in b/s
        echo usage: $0 [-r] -i network-interface
        echo e.g. $0 -i eth0
        echo -r outputs in raw format: timestamp tx rx
        exit 1
fi

while true
do
        R1=`cat /sys/class/net/$IF/statistics/rx_bytes`
        T1=`cat /sys/class/net/$IF/statistics/tx_bytes`
        sleep 1
        R2=`cat /sys/class/net/$IF/statistics/rx_bytes`
        T2=`cat /sys/class/net/$IF/statistics/tx_bytes`
        timestamp=`date +%s.%N`
        TBPS=`expr $T2 - $T1`
        RBPS=`expr $R2 - $R1`
        if [ "$kb" -eq 1 ]; then
          TSPEED=`expr $TBPS / 1024`
          RSPEED=`expr $RBPS / 1024`
          UNIT='kb/s'
        else
          TSPEED=$TBPS
          RSPEED=$RBPS
          UNIT='b/s'
        fi
		if [ "$raw" -eq 1 ]; then
          echo -e "$timestamp $TBPS $RBPS"
        else
          echo -e "[$timestamp]\ttx $IF: $TSPEED $UNIT   \trx $IF: $RSPEED $UNIT"
        fi
done

